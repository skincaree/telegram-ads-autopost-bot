#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø¨ÙˆØª ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ù„Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
Telegram Ads Auto-Posting Bot
"""

import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters
)
from config import BOT_TOKEN, ADMIN_IDS
from database import Database
from scheduler import SchedulerManager
from handlers.admin_panel import AdminPanel
from handlers.scheduler_handler import SchedulerHandler
from handlers.stats import StatsHandler

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

class TelegramAdsBot:
    def __init__(self):
        self.db = Database()
        self.scheduler_manager = SchedulerManager(self.db)
        self.admin_panel = AdminPanel(self.db)
        self.scheduler_handler = SchedulerHandler(self.db, self.scheduler_manager)
        self.stats_handler = StatsHandler(self.db)
        
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /start"""
        user = update.effective_user
        user_id = user.id
        
        # Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        self.db.add_user(user_id, user.username, user.first_name)
        
        keyboard = []
        
        # Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·
        if user_id in ADMIN_IDS:
            keyboard = [
                [InlineKeyboardButton("ğŸ“‹ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", callback_data="admin_panel")],
                [InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", callback_data="statistics")],
                [InlineKeyboardButton("â° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©", callback_data="manage_schedule")],
                [InlineKeyboardButton("â“ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©", callback_data="help")]
            ]
        else:
            keyboard = [
                [InlineKeyboardButton("â“ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©", callback_data="help")]
            ]
        
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        welcome_text = f"""
ğŸ¤– **Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.first_name}!**

Ø£Ù†Ø§ Ø¨ÙˆØª Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
Ø£Ù‚Ø¯Ù… Ù„Ùƒ Ø®Ø¯Ù…Ø§Øª Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø¢Ù„ÙŠ ÙˆÙ…Ø¬Ø¯ÙˆÙ„

**Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª:**
âœ… Ù†Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
âœ… Ø¬Ø¯ÙˆÙ„Ø© Ù…ØªÙ‚Ø¯Ù…Ø©
âœ… Ø¯Ø¹Ù… Ø§Ù„ÙˆØ³Ø§Ø¦Ø· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ØªÙØµÙŠÙ„ÙŠØ©

Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡:
        """
        
        await update.message.reply_text(
            welcome_text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± /help"""
        help_text = """
ğŸ“– **Ø¯Ù„ÙŠÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª**

**Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†:**
/start - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
/admin - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
/schedule - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
/stats - Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
/addpost - Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯
/listposts - Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
/channels - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª

**Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©:**
- ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØµÙ„ Ø§Ù„Ø²Ù…Ù†ÙŠ: Ù†Ø´Ø± ÙƒÙ„ X Ø¯Ù‚ÙŠÙ‚Ø©/Ø³Ø§Ø¹Ø©
- ÙˆØ¶Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯: Ù†Ø´Ø± ÙÙŠ Ø£ÙˆÙ‚Ø§Øª Ù…Ø­Ø¯Ø¯Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹

**Ø§Ù„Ø¯Ø¹Ù…:**
Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±
        """
        
        await update.message.reply_text(help_text, parse_mode='Markdown')
    
    async def callback_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©"""
        query = update.callback_query
        await query.answer()
        
        data = query.data
        user_id = query.from_user.id
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
        if data.startswith('admin_') and user_id not in ADMIN_IDS:
            await query.edit_message_text("â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„!")
            return
        
        # ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        if data == "admin_panel":
            await self.admin_panel.show_panel(update, context)
        elif data == "statistics":
            await self.stats_handler.show_stats(update, context)
        elif data == "manage_schedule":
            await self.scheduler_handler.show_schedule_menu(update, context)
        elif data == "help":
            await self.help_command(update, context)
    
    def run(self):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        application = Application.builder().token(BOT_TOKEN).build()
        
        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
        application.add_handler(CommandHandler("start", self.start_command))
        application.add_handler(CommandHandler("help", self.help_command))
        application.add_handler(CallbackQueryHandler(self.callback_handler))
        
        # ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        self.admin_panel.register_handlers(application)
        self.scheduler_handler.register_handlers(application)
        self.stats_handler.register_handlers(application)
        
        # Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„
        self.scheduler_manager.start()
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
        logger.info("ğŸš€ ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª Ø¨Ù†Ø¬Ø§Ø­!")
        application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == '__main__':
    bot = TelegramAdsBot()
    bot.run()
